<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí≥ SIT Store | Checkout</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
    <script src="./script/config.js"></script>
</head>
<body class="p-8 bg-gray-100 min-h-screen">
    <!-- Shared sidebar navigation -->
    <aside id="sidebar" class="fixed top-0 left-0 w-64 h-full bg-indigo-700 text-white flex flex-col z-40">
        <!-- Title + close button -->
        <div class="p-6 border-b border-indigo-500 flex justify-between items-center">
            <h1 class="text-xl font-bold">Next-Gen Store</h1>
            <button id="closeSidebar" class="text-white text-2xl font-bold">&times;</button>
        </div>

        <!-- üîΩ DB engine toggle (shared on all pages) -->
        <div class="px-6 py-3 border-b border-indigo-500 bg-indigo-800/40 text-xs space-y-1">
            <div class="flex items-center justify-between gap-2">
            <span class="uppercase tracking-wide text-[11px]">DB Engine</span>
            <select
                data-role="db-engine-select"
                class="text-black text-xs rounded px-2 py-1"
            >
                <option value="sql">SQL (Postgres)</option>
                <option value="nosql">NoSQL (MongoDB)</option>
            </select>
            </div>
            <p class="opacity-80">
            Current:
            <span
                data-role="db-engine-badge"
                class="font-semibold"
            ></span>
            </p>
        </div>

        <div id="timing-box"
            style="margin-top:16px; padding:16px; background:#eef; border-radius:8px; font-size:14px;">
        ‚è≥ Timing results will appear here...
        </div>


        <!-- existing nav links for this page go here -->
        <nav class="flex-grow p-4 space-y-2">
            <!-- keep your existing <a> links unchanged -->
            <a href="index.html#customer" class="block px-4 py-2 rounded-lg hover:bg-indigo-500 transition">üõç Customer View</a>
            <a href="cart.html" class="block px-4 py-2 rounded-lg hover:bg-indigo-500 transition">üõí Cart</a>
            <a href="checkout.html" class="block px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 transition">üí≥ Checkout</a>
            <a href="admin.html" class="block px-4 py-2 rounded-lg hover:bg-indigo-500 transition">‚öôÔ∏è Admin View</a>
            <a href="commands.html" class="block px-4 py-2 rounded-lg hover:bg-indigo-500 transition">üíª Commands</a>
        </nav>
    </aside>


  <!-- Hamburger button -->
  <button id="menuBtn" class="fixed top-5 left-5 bg-indigo-600 text-white p-2 rounded-md shadow-md z-50">‚ò∞</button>
    <div class="max-w-3xl mx-auto bg-white p-10 rounded-2xl shadow-3xl">
        <h1 class="text-4xl font-extrabold text-center text-cyan-600 mb-2">Checkout Details üí≥</h1>
        <p class="text-center text-gray-500 mb-8">Enter your information to complete your order.</p>

        <form id="checkoutForm" class="space-y-6">

            <div class="bg-indigo-50 p-6 rounded-xl border border-indigo-200">
                <h2 class="text-2xl font-semibold text-indigo-700 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z">
                        </path>
                    </svg>
                    Contact & Shipping
                </h2>

                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">Full Name</label>
                    <input type="text" id="name" name="name" required
                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-cyan-500 focus:ring-cyan-500 p-2">
                </div>

                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email Address</label>
                    <input type="email" id="email" name="email" required
                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-cyan-500 focus:ring-cyan-500 p-2">
                </div>

                <div>
                    <label for="address" class="block text-sm font-medium text-gray-700">Shipping Address</label>
                    <textarea id="address" name="address" required rows="3"
                              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-cyan-500 focus:ring-cyan-500 p-2"></textarea>
                </div>
            </div>

            <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Order Summary</h2>
                <p id="order-summary" class="text-lg font-bold text-teal-600">
                    Total: $0.00
                </p>
                <p class="text-sm text-gray-500 mt-2">
                    This summary is calculated from your current cart contents.
                </p>
            </div>

            <button type="submit" id="placeOrderBtn"
                    class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 rounded-xl transition-colors duration-300 shadow-lg text-xl">
                Place Order
            </button>

            <div id="message" class="mt-4 text-center font-medium"></div>
            <p id="perfInfo" class="mt-2 text-center text-sm text-gray-600"></p>

        </form>

    </div>

      <script>
        // Sidebar toggle (same behaviour as other pages)
        const sidebar = document.getElementById("sidebar");
        const menuBtn = document.getElementById("menuBtn");
        const closeSidebarBtn = document.getElementById("closeSidebar");

        if (sidebar && menuBtn && closeSidebarBtn) {
            menuBtn.onclick = () => sidebar.classList.add("active");
            closeSidebarBtn.onclick = () => sidebar.classList.remove("active");
        }

        // ---------------- Cart helpers ----------------
        function getCart() {
            try {
            return JSON.parse(localStorage.getItem("cartItems")) || [];
            } catch (e) {
            console.error("Failed to read cart from localStorage", e);
            return [];
            }
        }

        const SHIPPING_FEE = 5.0;
        const TAX_RATE = 0.05;

        function calculateTotals(cart) {
            const subtotal = cart.reduce(
            (sum, item) => sum + item.price * item.quantity,
            0
            );
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);

            let shipping = 0;
            let taxes = 0;
            let total = 0;

            if (totalItems > 0) {
            shipping = SHIPPING_FEE;
            taxes = subtotal * TAX_RATE;
            total = subtotal + shipping + taxes;
            }

            return { subtotal, totalItems, shipping, taxes, total };
        }

        const form = document.getElementById("checkoutForm");
        const messageDiv = document.getElementById("message");
        const placeOrderBtn = document.getElementById("placeOrderBtn");
        const orderSummaryEl = document.getElementById("order-summary");
        const perfInfo = document.getElementById("perfInfo");

        function renderOrderSummary() {
            const cart = getCart();
            if (!cart.length) {
            orderSummaryEl.textContent =
                "Your cart is empty. Please go back and add some products.";
            orderSummaryEl.classList.remove("text-teal-600");
            orderSummaryEl.classList.add("text-red-500");
            return;
            }

            orderSummaryEl.classList.remove("text-red-500");
            orderSummaryEl.classList.add("text-teal-600");

            const { subtotal, totalItems, shipping, taxes, total } =
            calculateTotals(cart);
            orderSummaryEl.textContent =
            `Items: ${totalItems} ‚Ä¢ Subtotal: $${subtotal.toFixed(
                2
            )} ` +
            `‚Ä¢ Shipping: $${shipping.toFixed(2)} ‚Ä¢ Tax: $${taxes.toFixed(
                2
            )} ` +
            `‚Ä¢ Total: $${total.toFixed(2)}`;
        }

        // Show current cart totals when page loads
        renderOrderSummary();

        // ---------------- Checkout submit ----------------
        form.addEventListener("submit", async function (e) {
            e.preventDefault();

            const cart = getCart();
            if (!cart.length) {
            messageDiv.className = "text-red-600";
            messageDiv.textContent =
                "Your cart is empty. Please add items before checking out.";
            return;
            }

            placeOrderBtn.disabled = true;
            placeOrderBtn.textContent = "Processing‚Ä¶";
            messageDiv.textContent = "";
            perfInfo.textContent = "";

            // Convert cart into backend format
            const items = cart.map((item) => ({
            id: item.id,
            quantity: item.quantity,
            price: item.price,
            }));

            // Clean + safe customer ID (same as SQL API expects)
            let customerId = document.getElementById("email").value.trim();
            customerId =
            customerId || "guest000000000000000000000000000"; // 32 chars
            customerId = customerId.slice(0, 32);

            const payload = {
            customer_id: customerId,
            items,
            };

            // Timings
            const tOverallStart = performance.now();
            let sqlRoundTripMs = null;
            let mongoRoundTripMs = null;

            try {
            const tSqlStart = performance.now();
            const tMongoStart = performance.now();

            const [sqlRes, mongoRes] = await Promise.all([
                fetch(sqlApi("/api/orders"), {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
                }),
                fetch(mongoApi("/api/orders"), {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
                }),
            ]);

            const tSqlEnd = performance.now();
            const tMongoEnd = performance.now();
            sqlRoundTripMs = tSqlEnd - tSqlStart;
            mongoRoundTripMs = tMongoEnd - tMongoStart;

            const [sqlJson, mongoJson] = await Promise.all([
                sqlRes.json().catch(() => ({})),
                mongoRes.json().catch(() => ({})),
            ]);

            const tOverallEnd = performance.now();
            const bothRoundTripMs = tOverallEnd - tOverallStart;

            const sqlOk = sqlRes.ok;
            const mongoOk = mongoRes.ok;

            const sqlOrderId = sqlJson?.orderId || "N/A";
            const mongoOrderId = mongoJson?.orderId || "N/A";

            const sqlDbMs =
                typeof sqlJson?.sqlDbMs === "number"
                ? sqlJson.sqlDbMs.toFixed(2)
                : "N/A";
            const sqlBackendMs =
                typeof sqlJson?.backendTotalMs === "number"
                ? sqlJson.backendTotalMs.toFixed(2)
                : "N/A";

            const mongoDbMs =
                typeof mongoJson?.mongoDbMs === "number"
                ? mongoJson.mongoDbMs.toFixed(2)
                : "N/A";

            const sqlRt =
                sqlRoundTripMs != null ? sqlRoundTripMs.toFixed(2) : "N/A";
            const mongoRt =
                mongoRoundTripMs != null ? mongoRoundTripMs.toFixed(2) : "N/A";

            // ----- Message text depending on success/failure -----
            if (sqlOk && mongoOk) {
                messageDiv.className = "text-green-700";
                messageDiv.innerHTML =
                `Order placed successfully in <strong>SQL</strong> and <strong>Mongo</strong>.<br>` +
                `SQL Order ID: <strong>${sqlOrderId}</strong><br>` +
                `Mongo Order ID: <strong>${mongoOrderId}</strong><br>` +
                `<a href="index.html#customer" class="underline text-cyan-700 mt-2 inline-block">Back to store</a>`;

                // Clear cart & form only if both succeeded
                localStorage.removeItem("cartItems");
                form.reset();
                renderOrderSummary();
            } else if (sqlOk && !mongoOk) {
                messageDiv.className = "text-yellow-700";
                messageDiv.innerHTML =
                `Order saved in <strong>SQL</strong>, but <strong>Mongo failed</strong> ` +
                `(${mongoJson?.error || mongoRes.status}).<br>` +
                `SQL Order ID: <strong>${sqlOrderId}</strong>.<br>` +
                `You can retry the Mongo write later from the Commands page.`;
            } else if (!sqlOk && mongoOk) {
                messageDiv.className = "text-yellow-700";
                messageDiv.innerHTML =
                `Order saved in <strong>Mongo</strong>, but <strong>SQL failed</strong> ` +
                `(${sqlJson?.error || sqlRes.status}).<br>` +
                `Mongo Order ID: <strong>${mongoOrderId}</strong>.`;
            } else {
                messageDiv.className = "text-red-600";
                messageDiv.innerHTML =
                `Order failed in <strong>both</strong> SQL and Mongo.<br>` +
                `SQL error: ${sqlJson?.error || sqlRes.status}<br>` +
                `Mongo error: ${mongoJson?.error || mongoRes.status}`;
            }

            // ----- Perf info line -----
            perfInfo.textContent =
                `SQL ‚Üí DB: ${sqlDbMs} ms | SQL backend: ${sqlBackendMs} ms | SQL end-to-end: ${sqlRt} ms || ` +
                `Mongo ‚Üí DB: ${mongoDbMs} ms | Mongo end-to-end: ${mongoRt} ms | ` +
                `End-to-end (click ‚Üí both responses): ${bothRoundTripMs.toFixed(
                2
                )} ms`;
            } catch (error) {
            console.error("Checkout error:", error);
            messageDiv.className = "text-red-600";
            messageDiv.innerHTML =
                `Error placing order: ${error.message}. Please try again.`;
            } finally {
            placeOrderBtn.disabled = false;
            placeOrderBtn.textContent = "Place Order";
            }
        });
        </script>



</body>
</html>
