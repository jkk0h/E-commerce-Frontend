<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>E-commerce — Products</title>

  <!-- Global styles (make sure styles.css exists) -->
  <link rel="stylesheet" href="styles.css">

  <!-- Config must be loaded before page scripts -->
  <script src="./script/config.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; background:#f7fafc; color:#111827; }
    .container { max-width:1100px; margin:32px auto; padding:0 16px; }
    .header { display:flex; gap:16px; align-items:center; justify-content:space-between; margin-bottom:20px; }
    .search-row { display:flex; gap:12px; align-items:center; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(220px,1fr)); gap:16px; margin-top:20px; }
    .card { background:white; border-radius:8px; padding:12px; box-shadow:0 1px 3px rgba(0,0,0,0.06); display:flex; flex-direction:column; }
    .card img { width:100%; height:160px; object-fit:cover; border-radius:6px; }
    .card h3 { margin:10px 0 6px; font-size:16px; }
    .price { color:#111827; font-weight:700; margin-bottom:8px; }
    .btn { display:inline-block; text-align:center; padding:8px 10px; border-radius:8px; text-decoration:none; color:white; background:#4f46e5; }
    .small-muted { color:#6b7280; font-size:13px; }
    @media (max-width:640px){ .header { flex-direction:column; align-items:stretch; gap:8px; } }
  </style>
</head>
<body>

  <div class="container">
    <div class="header">
      <div>
        <h1 style="margin:0 0 6px">Shop</h1>
        <div class="small-muted">Browse products — merged index</div>
      </div>

      <div class="search-row">
        <input id="searchInput" type="search" placeholder="Search products or SKU..." style="padding:8px 10px; border-radius:8px; border:1px solid #e5e7eb; min-width:220px;">
        <select id="sortSelect" style="padding:8px 10px; border-radius:8px; border:1px solid #e5e7eb;">
          <option value="">Sort</option>
          <option value="price-asc">Price: Low → High</option>
          <option value="price-desc">Price: High → Low</option>
          <option value="name-asc">Name: A → Z</option>
          <option value="name-desc">Name: Z → A</option>
        </select>
        <a class="btn" href="cart.html" style="margin-left:8px">View Cart</a>
      </div>
    </div>

    <div id="productsContainer" class="grid" aria-live="polite"></div>

    <div id="emptyMessage" style="display:none; margin-top:20px; color:#6b7280;">
      No products match your search.
    </div>
  </div>

  <script>
    (function () {
      // Build API helper from config.js
      const API_ROOT = window.getApiUrl ? window.getApiUrl("") : (window.API_URL || "");
      function api(path) { return (API_ROOT && !API_ROOT.endsWith("/") ? API_ROOT + "/" : API_ROOT) + (path.startsWith("/") ? path.slice(1) : path); }

      const container = document.getElementById("productsContainer");
      const searchInput = document.getElementById("searchInput");
      const sortSelect = document.getElementById("sortSelect");
      const emptyMessage = document.getElementById("emptyMessage");

      let allProducts = [];

      const getId    = p => p?.sku ?? p?.product_id ?? p?.id ?? "";
      const getName  = p => p?.title ?? p?.product_category_name ?? p?.name ?? "Unnamed product";
      const getPrice = p => { const raw = p?.price ?? p?.value ?? p?.price_value ?? 0; const n = Number.parseFloat(raw); return Number.isFinite(n) ? n : 0; };
      const getImage = p => p?.image_url ?? p?.image ?? p?.images?.[0] ?? "assets/placeholder.png";

      async function loadProducts() {
        try {
          const res = await fetch(api("/api/products"));
          if (!res.ok) throw new Error("Failed to fetch products: " + res.status);
          const json = await res.json();
          if (Array.isArray(json)) allProducts = json;
          else if (Array.isArray(json?.data)) allProducts = json.data;
          else if (Array.isArray(json?.results)) allProducts = json.results;
          else allProducts = Array.isArray(Object.values(json)) ? Object.values(json).flat() : [];
        } catch (err) {
          console.error("loadProducts error:", err);
          allProducts = [];
        }
        applyFiltersAndSort();
      }

      function applyFiltersAndSort() {
        const q = (searchInput?.value || "").trim().toLowerCase();
        let list = allProducts.filter(p => {
          const name = (getName(p) || "").toLowerCase();
          const id = String(getId(p) || "").toLowerCase();
          return !q || name.includes(q) || id.includes(q);
        });

        switch (sortSelect?.value) {
          case "price-asc": list.sort((a,b) => getPrice(a) - getPrice(b)); break;
          case "price-desc": list.sort((a,b) => getPrice(b) - getPrice(a)); break;
          case "name-asc": list.sort((a,b) => getName(a).localeCompare(getName(b))); break;
          case "name-desc": list.sort((a,b) => getName(b).localeCompare(getName(a))); break;
        }

        renderProducts(list);
      }

      function renderProducts(items) {
        if (!items || items.length === 0) { container.innerHTML = ""; emptyMessage.style.display = "block"; return; }
        emptyMessage.style.display = "none";

        container.innerHTML = items.map(p => {
          const id = encodeURIComponent(getId(p));
          const name = escapeHtml(getName(p));
          const price = getPrice(p).toFixed(2);
          const image = escapeAttr(getImage(p));
          return `
            <div class="card" data-id="${id}">
              <img src="${image}" alt="${name}" onerror="this.onerror=null;this.src='assets/placeholder.png'">
              <h3>${name}</h3>
              <div class="small-muted">SKU: ${id}</div>
              <div class="price">$${price}</div>
              <a class="btn" href="product-detail.html?id=${id}">View details</a>
            </div>
          `;
        }).join("");
      }

      function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
      function escapeAttr(s){ return String(s).replace(/"/g, '&quot;'); }

      searchInput?.addEventListener("input", debounce(applyFiltersAndSort, 180));
      sortSelect?.addEventListener("change", applyFiltersAndSort);

      function debounce(fn, wait) { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); }; }

      loadProducts();
    })();
  </script>
</body>
</html>
