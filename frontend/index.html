<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shop | Next-Gen Store</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="styles.css">

<!-- Auth helpers (getCurrentUser, etc.) -->
<script src="script/auth.js"></script>

<!-- API config (sqlApi/mongoApi) -->
<script src="./script/config.js"></script>


  <!-- Sidebar Slide Animation -->
  <style>
    #sidebar {
      transition: transform 0.3s ease-in-out;
      transform: translateX(-100%);
    }
    #sidebar.active { transform: translateX(0); }
    #sidebar.active ~ #menuBtn,
    #sidebar.active + #menuBtn {
      opacity: 0;
      pointer-events: none;
    }
  </style>
</head>
<body class="p-6 bg-gray-50">
   <!-- Global user / logout bar -->
  <div
    id="userBar"
    class="fixed top-4 right-4 z-50 flex items-center gap-2 bg-white/80 backdrop-blur px-3 py-1 rounded-full shadow border border-gray-200"
  >
    <span
      id="userLabel"
      class="text-xs sm:text-sm font-mono text-gray-700"
    >
      User: -
    </span>
    <button
      id="logoutBtn"
      class="text-xs sm:text-sm px-2 py-1 rounded-full bg-red-500 text-white hover:bg-red-600"
    >
      Logout
    </button>
  </div>
 
  <!-- SAME SIDEBAR AS COMMANDS.HTML -->
  <aside id="sidebar" class="fixed top-0 left-0 w-64 h-full bg-indigo-700 text-white flex flex-col z-40">
  <!-- Title + close button -->
    <div class="p-6 border-b border-indigo-500 flex justify-between items-center">
      <h1 class="text-xl font-bold">Next-Gen Store</h1>
      <button id="closeSidebar" class="text-white text-2xl font-bold">&times;</button>
    </div>


    <!-- existing nav links for this page go here -->
    <nav class="flex-grow p-4 space-y-2">
      <!-- keep your existing <a> links unchanged -->
      <a href="index.html#customer" id="nav-customer" class="block px-4 py-2 rounded-lg hover:bg-indigo-500 transition">üõç Customer View</a>
      <a href="admin.html"          id="nav-admin"    class="block px-4 py-2 rounded-lg hover:bg-indigo-500 transition">‚öôÔ∏è Admin View</a>
      <a href="commands.html"       id="nav-commands" class="block px-4 py-2 rounded-lg hover:bg-indigo-500 transition">üíª Commands</a>
    </nav>
  </aside>


  <button id="menuBtn" class="fixed top-5 left-5 bg-indigo-600 text-white p-2 rounded-md shadow-md z-50">‚ò∞</button>

  <!-- SAME LAYOUT AS COMMANDS.HTML -->
  <div class="max-w-7xl mx-auto bg-white p-8 rounded-xl shadow-2xl mt-10">
    <h1 class="text-4xl font-extrabold text-center text-indigo-700 mb-8">Shop</h1>

    <!-- Search & Sort -->
    <div class="flex flex-col md:flex-row gap-4 mb-8">
      <input id="searchInput" type="search" placeholder="Search products or Product ID / SKU..."
             class="flex-1 px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500">
      <select id="sortSelect" class="px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500">
        <option value="">Sort</option>
        <option value="price-asc">Price: Low to High</option>
        <option value="price-desc">Price: High to Low</option>
        <option value="name-asc">Name: A to Z</option>
        <option value="name-desc">Name: Z to A</option>
      </select>
      <a href="cart.html" class="px-6 py-3 bg-indigo-600 text-white font-bold rounded-full hover:bg-indigo-700 transition text-center">View Cart</a>
    </div>

    <!-- Products Grid -->
    <div id="productsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
    <div id="emptyMessage" class="text-center text-gray-500 py-12 text-lg hidden">
      No products match your search.
    </div>
  </div>

    <script>
      // === SHARED: SIDEBAR + HIGHLIGHT (API calls use sqlApi from config.js) ===

      const sidebar = document.getElementById("sidebar");
      document.getElementById("menuBtn").onclick = () => sidebar.classList.add("active");
      document.getElementById("closeSidebar").onclick = () => sidebar.classList.remove("active");
      
      // AUTO HIGHLIGHT CURRENT PAGE
      document.addEventListener("DOMContentLoaded", () => {
      // 1) Shared auth header + forced login
      setupAuthUI({ requireLogin: true });

      // 2) Sidebar highlight (unchanged)
      const page = location.pathname.split("/").pop() || "index.html";
      document
        .querySelectorAll("#sidebar nav a")
        .forEach((a) => a.classList.remove("bg-indigo-600"));

      if (page === "index.html")
        document.getElementById("nav-customer")?.classList.add("bg-indigo-600");
      if (page === "admin.html")
        document.getElementById("nav-admin")?.classList.add("bg-indigo-600");
      if (page === "commands.html")
        document.getElementById("nav-commands")?.classList.add("bg-indigo-600");
    });



      // === PRODUCT DISPLAY ===
      const container = document.getElementById("productsContainer");
      const searchInput = document.getElementById("searchInput");
      const sortSelect = document.getElementById("sortSelect");
      const emptyMessage = document.getElementById("emptyMessage");
      let allProducts = [];

      const getId    = p => p?.product_id ?? p?.sku ?? p?.id ?? "";
      const getName  = p => p?.title ?? p?.product_category_name ?? p?.name ?? "Unnamed";
      const getPrice = p => parseFloat(p?.price ?? p?.value ?? 0) || 0;
      const getImage = p => p?.image_url ?? p?.image ?? "assets/placeholder.png";

      async function loadProducts() {
        try {
          // üëá use SQL API explicitly
          const res = await fetch(sqlApi("/api/products"));
          const json = await res.json();
          allProducts = Array.isArray(json) ? json : json?.results || json?.data || [];
        } catch (e) { console.error(e); allProducts = []; }
        applyFiltersAndSort();
      }

      function applyFiltersAndSort() {
        let list = allProducts.filter(p => {
          const q = searchInput.value.trim().toLowerCase();
          return !q || getName(p).toLowerCase().includes(q) || getId(p).toLowerCase().includes(q);
        });

        switch (sortSelect.value) {
          case "price-asc":  list.sort((a,b) => getPrice(a) - getPrice(b)); break;
          case "price-desc": list.sort((a,b) => getPrice(b) - getPrice(a)); break;
          case "name-asc":   list.sort((a,b) => getName(a).localeCompare(getName(b))); break;
          case "name-desc":  list.sort((a,b) => getName(b).localeCompare(getName(a))); break;
        }
        render(list);
      }

      function render(items) {
        if (!items.length) {
          container.innerHTML = "";
          emptyMessage.classList.remove("hidden");
          return;
        }
        emptyMessage.classList.add("hidden");
        container.innerHTML = items.map(p => `
          <div class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition">
            <img src="${getImage(p)}" alt="${getName(p)}" class="w-full h-48 object-cover" onerror="this.src='assets/placeholder.png'">
            <div class="p-4">
              <p class="text-sm text-gray-500">Product ID: ${getId(p)}</p>
              <p class="text-2xl font-bold text-indigo-600 mt-2">$${getPrice(p).toFixed(2)}</p>
              <a href="product-detail.html?id=${getId(p)}" 
                class="block mt-4 text-center bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition">
                View Details
              </a>
            </div>
          </div>
        `).join("");
      }

      const debounce = (fn, wait) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), wait); }; };
      searchInput.addEventListener("input", debounce(applyFiltersAndSort, 200));
      sortSelect.addEventListener("change", applyFiltersAndSort);
      loadProducts();
  </script>

   <!-- NEW: force login + wire user bar -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      setupAuthUI({ requireLogin: true });
    });
  </script>

</body>
</html>