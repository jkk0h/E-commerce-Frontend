<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Details | The Next-Gen Store</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="styles.css">
  <script src="./script/config.js"></script>
</head>
<body class="bg-white text-gray-800">

  <div class="max-w-7xl mx-auto p-6 md:p-10">
    <header class="h-16 flex items-center border-b border-gray-100 mb-8">
      <h1 class="text-2xl font-bold text-indigo-600">SIT Store</h1>
      <a href="cart.html" class="ml-auto text-sm text-black font-semibold hover:text-indigo-600">View Bag</a>
      <a href="index.html" class="ml-4 text-sm text-indigo-600 hover:text-indigo-800">‚Üê Back to Store</a>
    </header>

    <div id="product-content-area" class="grid grid-cols-1 lg:grid-cols-2 gap-10">
      <div id="loading-state" class="col-span-full text-center py-20 text-gray-500">
        <p class="mt-2 text-xl">Loading Product Details...</p>
      </div>
    </div>
  </div>

  <script>
    const API_ROOT = window.getApiUrl ? window.getApiUrl("") : (window.API_URL || "");
    function api(path) { return (API_ROOT && !API_ROOT.endsWith("/") ? API_ROOT + "/" : API_ROOT) + (path.startsWith("/") ? path.slice(1) : path); }

    const contentArea = document.getElementById("product-content-area");
    const loadingState = document.getElementById("loading-state");

    function getProductIdFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('id');
    }

    function getCart() {
      try { return JSON.parse(localStorage.getItem('cartItems')) || []; } catch { return []; }
    }
    function saveCart(cart) { localStorage.setItem('cartItems', JSON.stringify(cart)); }

    function addToCart(id, name, price) {
      const itemPrice = parseFloat(price) || 0;
      let cart = getCart();
      const existingItem = cart.find(item => item.id === id);
      if (existingItem) existingItem.quantity += 1;
      else cart.push({ id, name, price: itemPrice, quantity: 1 });
      saveCart(cart);
      alert(`Added 1x ${name} to your bag.`);
    }

    function renderProduct(p) {
      const title = p.title || p.product_category_name || "Untitled Product";
      const subtitle = p.review_comment ? p.review_comment.substring(0,50)+'...' : "Check out the latest drop.";
      const priceText = p.price != null ? `$${parseFloat(p.price).toFixed(2)}` : "Price TBD";
      const description = p.product_description || "Product description placeholder.";
      const productId = p.sku || p.product_id || p.id || 'UNKNOWN';
      const productName = title.replace(/'/g, "\\'");
      const productPrice = p.price != null ? Number(p.price).toFixed(2) : '0';

      let specsHTML = `<div class="space-y-1 text-sm text-gray-600 mt-4">`;
      if (p.product_category_name) specsHTML += `<p><strong>Category:</strong> ${p.product_category_name}</p>`;
      if (p.freight_value != null) specsHTML += `<p><strong>Shipping Cost:</strong> $${parseFloat(p.freight_value).toFixed(2)}</p>`;
      if (p.product_weight_g != null) specsHTML += `<p><strong>Weight:</strong> ${p.product_weight_g} g</p>`;
      specsHTML += `</div>`;

      const html = `
        <div class="lg:sticky lg:top-10 h-[500px] bg-gray-100 flex items-center justify-center rounded-lg">
          <span class="text-gray-400 text-xl font-semibold"></span>
        </div>

        <div>
          <h2 class="text-xl font-normal text-gray-500">${subtitle}</h2>
          <h1 class="text-4xl font-extrabold mt-1 mb-2">${title}</h1>
          <p class="text-2xl font-semibold mb-6">${priceText}</p>
          <hr class="my-6">
          <div class="mb-6">
            <p class="font-semibold mb-2">Select Size</p>
            <div class="grid grid-cols-4 gap-2">
              <button class="size-option py-3 text-sm font-medium rounded-lg">US 8</button>
              <button class="size-option py-3 text-sm font-medium rounded-lg">US 9</button>
              <button class="size-option py-3 text-sm font-medium rounded-lg">US 10</button>
              <button class="size-option py-3 text-sm font-medium rounded-lg">US 11</button>
            </div>
          </div>

          <button onclick="addToCart('${productId}', '${productName}', ${productPrice})" class="w-full bg-black text-white py-3 rounded-full font-bold text-lg hover:bg-gray-700 transition-colors mb-2">
            Add to Bag
          </button>
          <button class="w-full bg-white text-black py-3 rounded-full font-bold text-lg border-2 border-gray-300 hover:border-black transition-colors">
            Favorite
          </button>
          <p class="text-xs text-red-500 mt-2">This product is excluded from site promotions and discounts.</p>
          <hr class="my-6">
          <p class="text-gray-700 leading-relaxed mb-6">${description}</p>
          <h3 class="font-bold text-lg mb-2">Product Specifications</h3>
          ${specsHTML}
          <div class="mt-6 text-sm">
            <p class="text-green-600 font-semibold">Free Delivery and Returns</p>
            <p class="text-gray-500">Style: ${productId}</p>
          </div>
        </div>
      `;

      contentArea.innerHTML = html;
    }

    async function loadProductDetails() {
      const productId = getProductIdFromUrl();
      if (!productId) {
        loadingState.innerHTML = `<p class="text-xl text-red-500">Error: No product ID specified in the URL.</p>`;
        return;
      }
      try {
        const res = await fetch(api(`/api/products/${encodeURIComponent(productId)}`));
        if (!res.ok) throw new Error(`Details for ID ${productId} not found (HTTP ${res.status}).`);
        const json = await res.json();
        // unwrap shapes: {success, product}, or just product
        const product = json?.product ?? json;
        loadingState.style.display = 'none';
        renderProduct(product);
      } catch (err) {
        console.error("Error fetching product details:", err);
        loadingState.innerHTML = `<p class="text-xl text-red-500">Failed to load product details: ${err.message}</p>`;
        loadingState.style.display = 'block';
      }
    }

    document.addEventListener('DOMContentLoaded', loadProductDetails);
  </script>
</body>
</html>
