<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Details | The Next-Gen Store</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="styles.css">
  <script src="./script/config.js"></script>
  <!-- NEW: auth helpers -->
  <script src="script/auth.js"></script>
</head>

<body class="bg-white text-gray-800">

  <div class="max-w-7xl mx-auto p-6 md:p-10">
    <header class="h-16 flex items-center border-b border-gray-100 mb-8">
      <h1 class="text-2xl font-bold text-indigo-600">SIT Store</h1>
      <a href="cart.html" class="ml-auto text-sm text-black font-semibold hover:text-indigo-600">View Bag</a>
      <a href="index.html" class="ml-4 text-sm text-indigo-600 hover:text-indigo-800">← Back to Store</a>
    </header>

    <div id="product-content-area" class="grid grid-cols-1 lg:grid-cols-2 gap-10">
      <div id="loading-state" class="col-span-full text-center py-20 text-gray-500">
        <p class="mt-2 text-xl">Loading Product Details...</p>
      </div>
    </div>
  </div>

  <!-- Single reviews section -->
  <section id="reviews-section" class="max-w-7xl mx-auto mt-8 px-6 md:px-10">
    <h2 class="text-2xl font-bold mb-4">Customer Reviews</h2>
    <select id="db-toggle" class="mb-4 p-2 border rounded">
      <option value="sql">SQL (Postgres)</option>
      <option value="nosql">NoSQL (MongoDB)</option>
    </select>
    <div id="reviews-container" class="space-y-4 max-h-96 overflow-y-auto border p-4 rounded-lg bg-white"></div>
  </section>

  <script>
    // ===================== PRODUCT DETAILS =====================
    const contentArea = document.getElementById("product-content-area");
    const loadingState = document.getElementById("loading-state");

    let productId; // global so reviews + analytics can use it

    function getProductIdFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get("id");
    }

    function getCart() {
      try { return JSON.parse(localStorage.getItem("cartItems")) || []; }
      catch { return []; }
    }
    function saveCart(cart) {
      localStorage.setItem("cartItems", JSON.stringify(cart));
    }

    function addToCart(id, name, price) {
      const itemPrice = parseFloat(price) || 0;
      let cart = getCart();
      const existingItem = cart.find((item) => item.id === id);
      if (existingItem) existingItem.quantity += 1;
      else cart.push({ id, name, price: itemPrice, quantity: 1 });
      saveCart(cart);
      alert(`Added 1x ${name} to your bag.`);
    }

    function renderProduct(p) {
      const title = p.title || p.product_category_name || "Untitled Product";
      const subtitle = p.review_comment
        ? p.review_comment.substring(0, 50) + "..."
        : "Check out the latest drop.";
      const priceText =
        p.price != null ? `$${Number(p.price).toFixed(2)}` : "Price unavailable";
      const productName = title;
      const productPrice = p.price || 0;
      const description = `
        The ${title} is a must-have for any collection. 
        Featuring premium materials and cutting-edge design, 
        it's perfect for everyday wear or special occasions.
      `;
      const specs = [
        { label: "Material", value: "Premium synthetic" },
        { label: "Sole", value: "Rubber" },
        { label: "Closure", value: "Lace-up" },
        { label: "Fit", value: "True to size" },
        { label: "Weight", value: "350g" },
        { label: "Order Count", value: p.order_count || 0 },
      ];
      const specsHTML = specs
        .map(
          (s) => `
        <div class="flex justify-between py-2 border-b border-gray-100">
          <span>${s.label}</span>
          <span class="font-medium">${s.value}</span>
        </div>
      `
        )
        .join("");

      const html = `
        <div class="relative">
          <img src="assets/placeholder.png" alt="${title}" class="w-full rounded-lg shadow-lg">
        </div>
        <div>
          <h1 class="text-3xl font-bold mb-2">${title}</h1>
          <p class="text-xl text-gray-600 mb-4">${subtitle}</p>
          <p class="text-2xl font-bold mb-6">${priceText}</p>

          <div class="mb-6">
            <h3 class="font-bold mb-2">Select Size</h3>
            <div class="grid grid-cols-4 gap-2">
              <button class="size-option py-3 text-sm font-medium rounded-lg">US 7</button>
              <button class="size-option py-3 text-sm font-medium rounded-lg">US 8</button>
              <button class="size-option py-3 text-sm font-medium rounded-lg">US 9</button>
              <button class="size-option py-3 text-sm font-medium rounded-lg">US 10</button>
              <button class="size-option py-3 text-sm font-medium rounded-lg">US 11</button>
            </div>
          </div>

          <button
            onclick="addToCart('${productId}', '${productName}', ${productPrice})"
            class="w-full bg-black text-white py-3 rounded-full font-bold text-lg hover:bg-gray-700 transition-colors mb-2"
          >
            Add to Bag
          </button>
          <button
            class="w-full bg-white text-black py-3 rounded-full font-bold text-lg border-2 border-gray-300 hover:border-black transition-colors"
          >
            Favorite
          </button>
          <p class="text-xs text-red-500 mt-2">
            This product is excluded from site promotions and discounts.
          </p>

          <hr class="my-6">

          <p class="text-gray-700 leading-relaxed mb-6">
            ${description}
          </p>

          <h3 class="font-bold text-lg mb-2">Product Specifications</h3>
          ${specsHTML}
          <div class="mt-6 text-sm">
            <p class="text-green-600 font-semibold">Free Delivery and Returns</p>
            <p class="text-gray-500">Style: ${productId}</p>
          </div>
        </div>
      `;

      contentArea.innerHTML = html;
    }

    async function loadProductDetails() {
      productId = getProductIdFromUrl();
      if (!productId) {
        loadingState.innerHTML =
          '<p class="text-xl text-red-500">Error: No product ID specified in the URL.</p>';
        return;
      }

      try {
        const res = await fetch(
          sqlApi(`/api/products/${encodeURIComponent(productId)}`)
        );
        if (!res.ok) {
          throw new Error(
            `Details for ID ${productId} not found (HTTP ${res.status}).`
          );
        }
        const json = await res.json();
        const product = json?.product ?? json;

        loadingState.style.display = "none";
        renderProduct(product);

        // Once product is known, load analytics & reviews
        await loadMonthlyStats();        // SQL MV
        await loadMongoReviewTrend();    // Mongo aggregation
        await loadReviews();             // Reviews (SQL/Mongo toggle)
      } catch (err) {
        console.error("Error fetching product details:", err);
        loadingState.innerHTML = `<p class="text-xl text-red-500">Failed to load product details: ${err.message}</p>`;
        loadingState.style.display = "block";
      }
    }

    // ===================== REVIEWS =====================
    let dbSource = "sql"; // "sql" or "nosql"
    const reviewsContainer = document.getElementById("reviews-container");
    const dbToggle = document.getElementById("db-toggle");

    dbToggle.addEventListener("change", () => {
      dbSource = dbToggle.value;
      loadReviews(); // reload from the other DB
    });

    async function loadReviews() {
      if (!productId) return;

      reviewsContainer.innerHTML =
        '<p class="text-gray-500">Loading reviews...</p>';

      const api = dbSource === "sql" ? sqlApi : mongoApi;
      const param = dbSource === "sql" ? "offset" : "skip";
      const url = `${api("/api/reviews/")}${encodeURIComponent(
        productId
      )}?limit=20&${param}=0`;

      try {
        const res = await fetch(url);
        if (!res.ok) {
          if (res.status === 404) {
            reviewsContainer.innerHTML =
              '<p class="text-gray-500">No reviews available for this product.</p>';
            return;
          }
          throw new Error(`HTTP ${res.status}`);
        }

        const { reviews } = await res.json();
        if (!reviews || reviews.length === 0) {
          reviewsContainer.innerHTML =
            '<p class="text-gray-500">No reviews yet.</p>';
          return;
        }

        reviewsContainer.innerHTML = "";
        reviews.forEach((review) => {
          const reviewDiv = document.createElement("div");
          reviewDiv.className = "border-b py-4";
          reviewDiv.innerHTML = `
            <div class="flex justify-between">
              <span class="font-bold">${review.score} ⭐</span>
              <span class="text-sm text-gray-500">${
                review.creation_date || "N/A"
              }</span>
            </div>
            <p class="font-semibold">${
              review.title ? review.title : "No Title"
            }</p>
            <p>${review.message || ""}</p>
          `;
          reviewsContainer.appendChild(reviewDiv);
        });
      } catch (err) {
        console.error("Error fetching reviews:", err);
        reviewsContainer.innerHTML =
          '<p class="text-red-500">Error loading reviews. Please try again.</p>';
      }
    }

    // ===================== SQL MONTHLY ANALYTICS (MV) =====================
    async function loadMonthlyStats() {
      if (!productId) {
        console.error("Product ID not set for monthly stats fetch.");
        return;
      }

      try {
        const res = await fetch(
          sqlApi(
            `/api/monthly-stats/${encodeURIComponent(
              productId
            )}?from=2017-01-01&to=2017-12-31`
          )
        );
        if (!res.ok) {
          console.warn("Monthly stats fetch failed:", res.status);
          return;
        }

        const { stats } = await res.json();
        const safeStats = Array.isArray(stats) ? stats : [];

        const old = document.getElementById("monthly-stats");
        if (old) old.remove();

        const statsContainer = document.createElement("section");
        statsContainer.id = "monthly-stats";
        statsContainer.className = "max-w-7xl mx-auto mt-10 px-6 md:px-10";

        let rowsHtml;
        if (safeStats.length === 0) {
          rowsHtml = `
            <tr>
              <td colspan="4" class="py-3 text-center text-gray-500">
                No SQL materialized view data available for this product.
              </td>
            </tr>`;
        } else {
          rowsHtml = safeStats
            .map(
              (s) => `
            <tr>
              <td class="py-2 border-b">${s.order_month}</td>
              <td class="py-2 border-b">${s.num_orders}</td>
              <td class="py-2 border-b">${
                s.avg_review_score != null
                  ? Number(s.avg_review_score).toFixed(2)
                  : "–"
              }</td>
              <td class="py-2 border-b">${
                s.total_payment_value != null
                  ? "$" + Number(s.total_payment_value).toFixed(2)
                  : "$0.00"
              }</td>
            </tr>`
            )
            .join("");
        }

        statsContainer.innerHTML = `
          <h3 class="text-2xl font-bold mb-4">Monthly Analytics (SQL Materialized View)</h3>
          <table class="w-full border-collapse bg-white rounded-lg shadow-sm overflow-hidden">
            <thead class="bg-gray-100">
              <tr>
                <th class="text-left py-2 px-3 border-b">Month</th>
                <th class="text-left py-2 px-3 border-b">Orders</th>
                <th class="text-left py-2 px-3 border-b">Avg Review Score</th>
                <th class="text-left py-2 px-3 border-b">Sales (Payment Value)</th>
              </tr>
            </thead>
            <tbody>
              ${rowsHtml}
            </tbody>
          </table>
        `;

        const reviewsSection = document.getElementById("reviews-section");
        reviewsSection.insertAdjacentElement("afterend", statsContainer);
      } catch (err) {
        console.error("Error loading monthly stats:", err);
      }
    }

    // ===================== MONGO REVIEW TREND (AGGREGATION) =====================
    async function loadMongoReviewTrend() {
      if (!productId) {
        console.error("Product ID not set for Mongo trend fetch.");
        return;
      }

      try {
        const res = await fetch(
          mongoApi(
            `/api/analytics/reviews-trend/${encodeURIComponent(
              productId
            )}?granularity=month`
          )
        );
        if (!res.ok) {
          console.warn("Mongo review trend fetch failed:", res.status);
          return;
        }

        const { trend, mongoDbMs } = await res.json();
        const safeTrend = Array.isArray(trend) ? trend : [];

        const old = document.getElementById("mongo-review-trend");
        if (old) old.remove();

        const trendContainer = document.createElement("section");
        trendContainer.id = "mongo-review-trend";
        trendContainer.className = "max-w-7xl mx-auto mt-6 px-6 md:px-10";

        let rowsHtml;
        if (safeTrend.length === 0) {
          rowsHtml = `
            <tr>
              <td colspan="3" class="py-3 text-center text-gray-500">
                No MongoDB review trend data available for this product.
              </td>
            </tr>`;
        } else {
          rowsHtml = safeTrend
            .map(
              (t) => `
            <tr>
              <td class="py-2 border-b">${t.bucket}</td>
              <td class="py-2 border-b">${t.num_reviews}</td>
              <td class="py-2 border-b">${
                t.avg_score != null ? Number(t.avg_score).toFixed(2) : "–"
              }</td>
            </tr>`
            )
            .join("");
        }

        trendContainer.innerHTML = `
          <h3 class="text-2xl font-bold mb-2">MongoDB Review Trend (Aggregation Pipeline)</h3>
          <p class="text-sm text-gray-500 mb-3">
            Computed on-the-fly with <code>$match → $addFields → $group → $project → $sort</code>.
            ${mongoDbMs != null ? `Mongo DB time: ${mongoDbMs.toFixed(2)} ms.` : ""}
          </p>
          <table class="w-full border-collapse bg-white rounded-lg shadow-sm overflow-hidden">
            <thead class="bg-gray-100">
              <tr>
                <th class="text-left py-2 px-3 border-b">Month</th>
                <th class="text-left py-2 px-3 border-b"># Reviews</th>
                <th class="text-left py-2 px-3 border-b">Avg Review Score</th>
              </tr>
            </thead>
            <tbody>
              ${rowsHtml}
            </tbody>
          </table>
        `;

        const monthlyStats = document.getElementById("monthly-stats") || document.getElementById("reviews-section");
        monthlyStats.insertAdjacentElement("afterend", trendContainer);
      } catch (err) {
        console.error("Error loading Mongo review trend:", err);
      }
    }

    // ===================== PAGE INIT =====================
    document.addEventListener("DOMContentLoaded", () => {
      loadProductDetails();
      loadMongoReviewTrend()
    });
  </script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
      setupAuthUI({ requireLogin: true });
    });
  </script>
</body>
</html>
