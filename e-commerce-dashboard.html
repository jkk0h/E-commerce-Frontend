<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-commerce Dashboard (Product & Inventory)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            border: 1px solid #e5e7eb;
            padding: 0.75rem;
            text-align: left;
        }
        th {
            background-color: #eef2ff;
        }
    </style>
</head>
<body class="p-6">
    <div class="absolute top-6 right-6 space-x-4">
        <a href="data_management.html" class="bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-300 transform hover:scale-105 shadow-lg">
            Manage Data (CRUD)
        </a>
        <a href="commands.html" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-300 transform hover:scale-105 shadow-lg">
            SQL Command Interface
        </a>
    </div>

    <div class="max-w-7xl mx-auto bg-white p-8 rounded-xl shadow-2xl">
        <h1 class="text-4xl font-extrabold text-center text-gray-800 mb-8">E-commerce Product & Inventory Dashboard</h1>

        <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-800 p-6 rounded-lg mb-8 shadow-inner">
            <h2 class="text-3xl font-bold mb-4">Full Product/SKU Listing & Inventory</h2>
            <p class="mb-4">This dashboard view shows all individual product variants ($\text{SKU}$s) and their current $\text{Stock}$ levels from your single table.</p>
            <button id="fetch-mysql-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-full transition-colors duration-300 transform hover:scale-105">Refresh All Data</button>
            
            <div id="mysql-data" class="mt-6 space-y-4">
                <h3 class="text-xl font-semibold text-blue-900 mb-2">Detailed SKU Report</h3>
                <table class="min-w-full divide-y divide-gray-200 shadow-lg rounded-lg overflow-hidden">
                    <thead class="bg-blue-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SKU Code</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Design No.</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Size</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Color</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>
        
        <div class="p-6 text-center text-gray-600 border-t mt-8">
            <p>To **Add New Records** or **Update Inventory**, please visit the 
            <a href="data_management.html" class="text-yellow-600 font-semibold hover:text-yellow-700">Data Management Page</a>.</p>
        </div>

    </div>

    <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title"></h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500" id="modal-message"></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="close-modal-btn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>

        const API_URL = 'http://localhost:3000/api';
        //const API_URL = 'https://b58389f21dec.ngrok-free.app/api'; 
        
        const fetchBtn = document.getElementById('fetch-mysql-btn');
        const dataTableBody = document.getElementById('data-table-body');
        const messageModal = document.getElementById('message-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const closeModalBtn = document.getElementById('close-modal-btn');
        closeModalBtn.addEventListener('click', () => { messageModal.classList.add('hidden'); });

        function showMessage(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            messageModal.classList.remove('hidden');
        }

        function renderTable(data) {
            dataTableBody.innerHTML = '';
            if (data.length === 0) {
                dataTableBody.innerHTML = `<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No data available in the table.</td></tr>`;
                return;
            }

            data.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-100 transition-colors duration-200';
                
                row.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap">${item.SKU_code}</td>
                    <td class="px-4 py-4 whitespace-nowrap">${item.Design_No}</td>
                    <td class="px-4 py-4 whitespace-nowrap">${item.Category}</td>
                    <td class="px-4 py-4 whitespace-nowrap">${item.Size}</td>
                    <td class="px-4 py-4 whitespace-nowrap">${item.Color}</td>
                    <td class="px-4 py-4 whitespace-nowrap font-bold text-lg">${item.Stock}</td>
                    <td class="px-4 py-4 whitespace-nowrap"><button data-sku="${item.SKU_code}" class="quick-update-btn text-blue-600 hover:text-blue-800 font-semibold">Update Stock</button></td>
                `;
                dataTableBody.appendChild(row);
            });
            
            document.querySelectorAll('.quick-update-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const sku = e.target.getAttribute('data-sku');
                    const newStock = prompt(`Enter new stock for SKU ${sku}:`);
                    if (newStock !== null && !isNaN(parseInt(newStock))) {
                        updateStock(sku, parseInt(newStock)); 
                    }
                });
            });
        }
        
        fetchBtn.addEventListener('click', async () => {
            dataTableBody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Loading...</td></tr>';

            try {
                const response = await fetch(`${API_URL}/all-records`); 
                
                if (!response.ok) {
                    throw new Error('Server response was not OK');
                }

                const data = await response.json(); 
                renderTable(data);

            } catch (error) {
                console.error('Error fetching data:', error);
                showMessage("Error", "Failed to fetch data from the database. Check server logs.");
                dataTableBody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-red-600">Failed to fetch data.</td></tr>';
            }
        });

        async function updateStock(sku, newStock) {
            try {
                const response = await fetch(`${API_URL}/update-stock/${sku}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stock: newStock })
                });
                const result = await response.json();
                if (response.ok) {
                    showMessage("Success!", `Stock for SKU ${sku} updated (MySQL UPDATE).`);
                    fetchBtn.click();
                } else {
                    showMessage("Error", result.error || "Failed to update stock. SKU not found or server error.");
                }
            } catch (error) {
                showMessage("Error", "Network error during stock update.");
            }
        }
        
        fetchBtn.click();
    </script>
</body>
</html>